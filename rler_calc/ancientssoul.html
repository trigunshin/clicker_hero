

<html>
<head>
<link rel="shortcut icon" href="http://www.rivsoft.net/content/favico.png" />
<title>ClickerHeroes Ancients optimizer</title>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/md5.js"></script>
<script src="http://www.rivsoft.net/content/spin.min.js"></script>
<!--<script src="spin.min.js"></script>-->
<style type="text/css">
.datatable {
  border: 2px solid black;
}
.datatable td, th {
  overflow: hidden;
  white-space: nowrap;
}
.datatable td {
  text-indent: 5px;
  border-right: 1px solid #ccc;
  border-bottom: 1px solid #ccc;
}
.datatable tr:last-child td {
  border-bottom: 0px !important;
}
.datatable td:last-child {
  border-right: 0px !important;
}
.datatable th {
  border-right: 1px solid black;
  border-bottom: 2px solid black;
}
.datatable th:last-child {
  border-right: 0px !important;
}
.datatable input[type=checkbox] {
  margin: 0px 3px 0px 0px;
  position: relative;
  top: 1px;
}
.datatable input:not([type=checkbox]) {
  border: 0px;
  width: 100%;
  height: 100%;
}
.datatable input:not([type=checkbox]):focus {
  outline: 0;
}
.datatable .hilite {
  background-color: #afa;
}
.datatable .hilite input {
  background-color: #afa;
}
hr {
  margin: 1px;
}
#nonidle input {
  width: 100px;
}
</style>
</head>
<body>

<p>
This is a new & improved ancients optimizer that optimizes the most important metric of all - soul farm efficiency.<br/>
Note that idle mode does not use DR. If you want to include it while still using idle mode (minus two minutes for
using the abilities), uncheck idle mode and set every field inside to zero.<br/>
Early level simulation is currently pretty bad, so it is best to leave Khrysos and Iris disabled (unchecked).<br/>
It is highly recommended that you actually paste in your save data instead of entering the levels manually, since there is a lot of other data it uses, such as gilded levels.
</p>

<div>
Paste save data (click wrench, click Save, close the save prompt because its already copied to clipboard):
<textarea id="savedata" style="width: 100%; height: 50px" onfocus="this.select()" onmouseup="return false">
</textarea>
<input type="button" value="Import" onclick="Import()" style="margin-bottom: 12px"></input>
<label><input type="checkbox" id="addsouls" checked="checked"></input>Include souls gained after ascension</label>
</div>

<div>
<label><input type="checkbox" id="idlemode" checked="checked"></input>Idle mode (no clicks/abilities)</label>
<div id="nonidle" style="display: none">
 <table border="0">
  <tr><th>Cooldown usage:</th><th>Uses/30 min</th><th>Clicks/sec</th></tr>
  <tr>
   <td>Full (1+2+3+4+5+7):</td>
   <td><input type="text" id="cdfullnum" value="2"></input></td>
   <td><input type="text" id="cdfullcps" value="40"></input></td>
  </tr>
  <tr>
   <td>Half (1+2+3+4):</td>
   <td><input type="text" id="cdhalfnum" value="1"></input></td>
   <td><input type="text" id="cdhalfcps" value="40"></input></td>
  </tr>
  <tr>
   <td>Short (1+2):</td>
   <td><input type="text" id="cdshortnum" value="4"></input></td>
   <td><input type="text" id="cdshortcps" value="40"></input></td>
  </tr>
  <tr>
   <td>None:</td>
   <td></td>
   <td><input type="text" id="cdnonecps" value="40"></input></td>
  </tr>
 </table>
</div>
</div>
<br/>
<div id="herodiv">
<div>
Leave current level blank or 0 if you don't own the ancient.
</div>
<div style="display: inline-block; vertical-align: top;">
<table id="ancienttbl" border="0" cellspacing="0" class="datatable">
 <tr><th>Ancient</th><th>Current</th><th>Target</th></tr>
 <tr>
  <td>Hero Souls</td>
  <td><input type="text" id="soulsin" value="0"></input></td>
  <td><input type="text" id="soulsout" readonly="readonly" tabindex="-1"></input></td>
 </tr>
</table>
</div>
<div style="display: inline-block; vertical-align: top;">
<table id="heroestbl" border="0" cellspacing="0" class="datatable">
 <tr><th>Hero</th><th>Gilds</th></tr>
</table>
</div>

<!--<label><input type="checkbox" id="suggestbuy" checked="checked"></input>Suggest additional ancients to purchase (can be slow if the number of souls is very high)</label>-->
</div>
<input type="button" value="Update" onclick="StartCompute()"></input>
<div id="output">
</div>

<script language="javascript">
$("#idlemode").change(function() {
  if (this.checked) {
    $("#nonidle").slideUp();
  } else {
    $("#nonidle").slideDown();
  }
});

var loadSpinner = new Spinner({
  lines: 13, // The number of lines to draw
  length: 10, // The length of each line
  width: 4, // The line thickness
  radius: 15, // The radius of the inner circle
  corners: 1, // Corner roundness (0..1)
  rotate: 0, // The rotation offset
  direction: 1, // 1: clockwise, -1: counterclockwise
  color: '#000', // #rgb or #rrggbb or array of colors
  speed: 1, // Rounds per second
  trail: 60, // Afterglow percentage
  shadow: false, // Whether to render a shadow
  hwaccel: false, // Whether to use hardware acceleration
  className: 'spinner', // The CSS class to assign to the spinner
  zIndex: 2e9, // The z-index (defaults to 2000000000)
  top: '50%', // Top position relative to parent
  left: '50%' // Left position relative to parent
});

var AbaddonMultiplier = null;

var Achievements = {
  "13": 1, // hoard
  "14": 2, // hoard
  "15": 3, // hoard
   "1": 1, // zone
   "2": 2, // zone
   "3": 3, // zone
  "61": 0, // omeet
  "33": 1, // dps
  "34": 2, // dps
  "35": 3, // dps
  "37": 0, // click 12
  "38": 0, // click 14
  "39": 3, // click
  "41": 3, // crit
  "43": 0, // ascend 1
  "44": 0, // ascend 3
  "45": 0, // ascend 5
  "46": 0, // ascend 10
  "59": 0, // ascend 25
  "21": 1, // boss
  "22": 2, // boss
  "23": 3, // boss
   "5": 1, // click
   "6": 2, // click
   "7": 3, // click
   "9": 1, // gold
  "10": 2, // gold
  "11": 3, // gold
  "29": 1, // level
  "30": 2, // level
  "31": 3, // level
  "17": 1, // kill
  "18": 2, // kill
  "19": 3, // kill
  "25": 1, // upgrade
  "26": 2, // upgrade
  "27": 3, // upgrade
};
var Upgrades = {
  "12": 25,
  "25": 20,
  "26": 20,
  "27": 20,
  "28": 20,
  "36": 25,
  "57": 25,
  "82": 20,
  "83": 20,
  "87": 10,
  "97": 10,
  "120": 25,
  "122": 25,
  "126": 25,
};
var Ancients = {
  solomon: {name: "Solomon, Ancient of Wisdom", desc: "+5% to 1% Primal hero souls", power: 1.5, id: 3},
  libertas: {name: "Libertas, Ancient of Freedom", desc: "+25% to +15% idle Gold", power: 1, id: 4},
  siyalatas: {name: "Siyalatas, Ancient of Abandon", desc: "+25% to +15% idle DPS", power: 1, id: 5},
  khrysos: {name: "Khrysos, Ancient of Inheritance", desc: "+50 starting Gold when Ascending", power: 1.5, maxlvl: 10, id: 6},
  // thusia
  mammon: {name: "Mammon, Ancient of Greed", desc: "+5% Gold", power: 1, id: 8},
  mimzee: {name: "Mimzee, Ancient of Riches", desc: "+50% treasure chest Gold", power: 1, id: 9},
  pluto: {name: "Pluto, Ancient of Wealth", desc: "+30% Golden Clicks Gold", power: 1, id: 10},
  dogcog: {name: "Dogcog, Ancient of Thrift", desc: "-2% hero cost", power: 1, maxlvl: 25, id: 11},
  fortuna: {name: "Fortuna, Ancient of Chance", desc: "+0.25% chance of 10x Gold", power: 1, maxlvl: 40, id: 12},
  atman: {name: "Atman, Ancient of Souls", desc: "+1% primal boss chance", power: 1.5, maxlvl: 25, id: 13},
  dora: {name: "Dora, Ancient of Discovery", desc: "+20% more Treasure Chests", power: 1, maxlvl: 50, id: 14},
  bhaal: {name: "Bhaal, Ancient of Murder", desc: "+15% critical damage", power: 1, id: 15},
  morgulis: {name: "Morgulis, Ancient of Death", desc: "+11% DPS per Hero Soul Spent (cumulative)", power: 0, id: 16},
  // chronos
  bubos: {name: "Bubos, Ancient of Diseases", desc: "-2% boss life", power: 1, maxlvl: 25, id: 18},
  fragsworth: {name: "Fragsworth, Ancient of Wrath", desc: "+20% click damage", power: 1, id: 19},
  // vaagur
  kumawakamaru: {name: "Kumawakamaru, Ancient of Shadows", desc: "-1 monsters to advance", power: 1, maxlvl: 5, id: 21},
  chawedo: {name: "Chawedo, Ancient of Agitation", desc: "+2s Clickstorm duration", power: 1, maxlvl: 30, id: 22},
  hecatoncheir: {name: "Hecatoncheir, Ancient of Wallops", desc: "+2s Super Clicks duration", power: 1, maxlvl: 30, id: 23},
  berserker: {name: "Berserker, Ancient of Rage", desc: "+2s Powersurge duration", power: 1, maxlvl: 30, id: 24},
  sniperino: {name: "Sniperino, Ancient of Accuracy", desc: "+2s Lucky Strikes duration", power: 1, maxlvl: 30, id: 25},
  kleptos: {name: "Kleptos, Ancient of Thieves", desc: "+2s Golden Clicks duration", power: 1, maxlvl: 30, id: 26},
  energon: {name: "Energon, Ancient of Battery Life", desc: "+2s Metal Detector duration", power: 1, maxlvl: 30, id: 27},
  argaiv: {name: "Argaiv, Ancient of Enhancement", desc: "+2% Gilded bonus (per Gild)", power: 1, id: 28},
  juggernaut: {name: "Juggernaut, Ancient of Momentum", desc: "+0.01% DPS per click combo (active clicking)", power: 1.5, id: 29},
  iris: {name: "Iris, Ancient of Vision", desc: "+1 to starting zone after Ascension", power: 1.5, id: 30},
};
var Heroes = [
  {name: "Tree Beast"},
  {name: "Ivan, the Drunken Brawler"},
  {name: "Brittany, the Beach Princess"},
  {name: "The Wandering Fisherman"},
  {name: "Betty Clicker"},
  {name: "The Masked Samurai"},
  {name: "Leon"},
  {name: "The Great Forest Seer"},
  {name: "Alexa, the Assassin"},
  {name: "Natalia, Ice Apprentice"},
  {name: "Mercedes, Duchess of Blades"},
  {name: "Bobby, Bounty Hunter"},
  {name: "Broyle Lindoven, Fire Mage"},
  {name: "Sir George II, King's Guard"},
  {name: "King Midas"},
  {name: "Referi Jerator, Ice Wizard"},
  {name: "Abaddon"},
  {name: "Ma Zhu"},
  {name: "Amenhotep"},
  {name: "Beastlord"},
  {name: "Athena, Goddess of War"},
  {name: "Aphrodite, Goddess of Love"},
  {name: "Shinatobe, Wind Deity"},
  {name: "Grant, the General"},
  {name: "Frostleaf"},
  {name: "Dread Knight"},
  {name: "Atlas"},
  {name: "Terra"},
  {name: "Phthalo"},
  {name: "Orntchya Gladeye, Didensy Banana"},
  {name: "Lilin"},
  {name: "Cadmia"},
  {name: "Alabaster"},
  {name: "Astraea"}
];
var AncientMin = 3;
var AncientMax = 30;

var AchievementMultiplier = 1;
var ToPurchase = [1,2,4,8,16,35,70,125,250,500,800,1200,1700,2200,2750,3400,4100,5000,6000,7500,10000,12500,16000,25000,35000,50000,70000,100000,150000,250000,400000];
var Seed = null;
var OwnedNotInList = 1;
function Random(a, b) {
  Seed = (Seed * 16807) % 2147483647;
  return (Seed % (b - a)) + a;
}
function RandRoll(cnt) {
  for (var i = 0; i < cnt; i++) {
    Random(0, 1);
  }
}
function GetAncientsList(levels, first) {
  var SaveSeed = Seed;
  var remains = [];
  for (var i = AncientMin; i <= AncientMax; i++) {
    if (!levels[i]) {
      remains.push(i);
    }
  }
  var out = {};
  var count = 0;
  if (!levels[20] && first) {
    out[20] = true;
    count++;
  }
  while (count < 4 && count < remains.length) {
    var cur = Random(0, remains.length);
    if (!levels[remains[cur]] && !out[remains[cur]]) {
      out[remains[cur]] = true;
      count++;
    }
  }
  Seed = SaveSeed;
  return out;
}
function GetGildedHeroes() {
	var gildedHeroes = new Array(Heroes.length);
	for (var i = 0; i < Heroes.length; i++) {
		gildedHeroes[i] = parseInt(Heroes[i].gildBox.val());
		if (!gildedHeroes[i])
			gildedHeroes[i] = 0;
	}
	return gildedHeroes;
}
function SetDifference(a, b) {
  var cnt = 0;
  for (var k in b) {
    if (!a.hasOwnProperty(k)) {
      cnt++;
    }
  }
  return cnt;
}
function UpdateAncientPrices(levels, didGetVaagur) {
  var prices = {};
  var owned = 0;
  for (var i = AncientMin; i <= AncientMax; i++) {
    if (levels[i]) {
      owned++;
    }
  }
  var priceSet = 0;
  var remaining = (AncientMax - AncientMin + 1) - owned;
  var curSet = GetAncientsList(levels, !didGetVaagur);
  for (var k in curSet) {
    prices[k] = 0;
    priceSet++;
  }
  var curPrice = 0;
  while (priceSet < remaining) {
    var nextSet = {};
    while (SetDifference(curSet, nextSet) < Math.min(4, remaining - 4)) {
      RandRoll(4);
      nextSet = GetAncientsList(levels);
    }
    curPrice += 1;
    curSet = nextSet;
    for (var k in curSet) {
      if (!prices.hasOwnProperty(k)) {
        prices[k] = curPrice;
        priceSet++;
      }
    }
  }
  for (var i in Ancients) {
    var id = Ancients[i].id;
    if (levels[id] || !prices[id]) {
      Ancients[i].rolls = 0;
    } else {
      Ancients[i].rolls = prices[id];
    }
  }
}

var ancientList = [];
for (var k in Ancients) {
  if (Ancients.hasOwnProperty(k)) {
    ancientList.push(k);
  }
}
ancientList.sort();
for (var i = 0; i < ancientList.length; i++) {
  var key = ancientList[i];
  var tr = $("<tr></tr>");
  Ancients[key].used = $("<input></input>").attr("type", "checkbox").attr("title", "Optimize this ancient");
  //if (key != "khrysos" && key != "iris") {
    Ancients[key].used.prop("checked", true);
  //}
  tr.append($("<td></td>").append(Ancients[key].used).append($("<span></span>").text(Ancients[key].name).attr("title", Ancients[key].desc)));
  Ancients[key].level = $("<input></input>").attr("type", "text").val(0);
  Ancients[key].target = $("<input></input>").attr("type", "text").attr("readonly", "readonly").attr("tabindex", "-1");
  Ancients[key].targetBox = $("<td></td>").append(Ancients[key].target);
  tr.append($("<td></td>").append(Ancients[key].level)).append(Ancients[key].targetBox);
  $("#ancienttbl").append(tr);
}

for (var i = 0; i < Heroes.length; i++) {
  var tr = $("<tr></tr>");
  tr.append($("<td></td>").append(Heroes[i].name));
  Heroes[i].gildBox = $("<input></input>").attr("type", "text").val(0);
  tr.append($("<td></td>").append(Heroes[i].gildBox));
  $("#heroestbl").append(tr);
}

const ANTI_CHEAT_CODE = "Fe12NAfA3R6z4k0z";
const SALT = "af0ik392jrmt0nsfdghy0";
function Import() {
  var txt = $("#savedata").val();
  if (txt.search(ANTI_CHEAT_CODE) != -1) {
    var result = txt.split(ANTI_CHEAT_CODE);
    txt = "";
    for (var i = 0; i < result[0].length; i += 2) {
      txt += result[0][i];
    }
    if (CryptoJS.MD5(txt + SALT) != result[1]) {
      alert("Bad hash");
      return;
    }
  }
  var data = $.parseJSON(atob(txt));

  var heroes = data.heroCollection.heroes;
  var ascSouls = 0;
  for (var k in heroes) {
    var id = parseInt(k);
    ascSouls += heroes[k].level;
    if (id < 2 || id > 35) continue;
	Heroes[id - 2].gildBox.val(heroes[k].epicLevel);
  }
  ascSouls = Math.floor(ascSouls / 2000) + data.primalSouls;

  var mult = 1;
  for (var k in data.achievements) {
    if (data.achievements[k]) {
      if (Achievements.hasOwnProperty(k)) {
        mult *= 1 + 0.01 * Achievements[k];
      } else {
        mult *= 1.05;
      }
    }
  }
  AchievementMultiplier = mult;
  for (var k in data.upgrades) {
    if (data.upgrades[k] && Upgrades.hasOwnProperty(k)) {
      mult *= 1 + 0.01 * Upgrades[k];
    }
  }
  for (var k in Upgrades) {
    AchievementMultiplier *= (1 + 0.01 * Upgrades[k]);
  }
  AbaddonMultiplier = data.allDpsMultiplier / mult;

  Seed = data.ancients.ancientsRoller.seed;
  var levels = {};
  OwnedNotInList = 0;
  for (var i = 3; i <= 28; i++) {
    if (data.ancients.ancients.hasOwnProperty(i)) {
      levels[i] = true;
      OwnedNotInList += 1;
    }
  }
  for (var k in Ancients) {
    if (levels[Ancients[k].id]) {
      OwnedNotInList -= 1;
    }
  }
  UpdateAncientPrices(levels, data.ancients.didGetVaagur);

  $("#soulsin").val(data.heroSouls + ($("#addsouls").prop("checked") ? ascSouls : 0));
  for (var k in Ancients) {
    if (Ancients.hasOwnProperty(k)) {
      if (data.ancients.ancients[Ancients[k].id]) {
        Ancients[k].level.val(data.ancients.ancients[Ancients[k].id].level);
      } else {
        Ancients[k].level.val(0);
      }
    }
  }
  StartCompute();
}

function FormatFactor(fct) {
  return parseFloat(((fct - 1) * 100).toFixed(1)) + "%";
}
function FormatTime(sec) {
  if (sec > 3600 * 24) {
    var hours = Math.round(sec / 3600);
    var days = Math.floor(hours / 24);
    hours -= days * 24;
    if (hours) {
      return days + "d" + hours + "h";
    } else {
      return days + " days";
    }
  } else if (sec > 3600) {
    var mins = Math.round(sec / 60);
    var hours = Math.floor(mins / 60);
    mins -= hours * 60;
    if (mins) {
      return hours + "h" + mins + "m";
    } else {
      return hours + " hours";
    }
  } else {
    var mins = Math.round(sec / 60);
    return mins + " minutes";
  }
}

function AncientPrice(ancient, level) {
  var price = Math.round(Math.pow(level, Ancients[ancient].power));
  if (ancient == "kumawakamaru") {
    price *= 10;
  }
  return price;
}

var curAddAncients = null;
var curLevels = null;
var curUsed = null;
var curSouls = null;
var curActivity = null;
var curOutFactor = null;

var computeThread = null;
function onAddAncient(e) {
  var ancient = e.data.ancient;
  var ratio = e.data.outFactor.ratio;
  var pos = 0;
  while (pos < curAddAncients.length && curAddAncients[pos].ancient != ancient) {
    pos++;
  }
  if (pos >= curAddAncients.length) {
    return;
  }
  curAddAncients[pos].ratio = ratio;
  var newPos = pos;
  while (newPos > 0 && (!curAddAncients[newPos - 1].ratio || curAddAncients[newPos - 1].ratio < ratio)) {
    newPos--;
  }
  if (newPos < pos) {
    curAddAncients[newPos].line.before(curAddAncients[pos].line);
    var tmp = curAddAncients[pos];
    for (var i = pos; i > newPos; i--) {
      curAddAncients[pos] = curAddAncients[pos - 1];
    }
    curAddAncients[newPos] = tmp;
    pos = newPos;
  }
  $("#add" + ancient).text("(" + Math.round(ratio * 3600) + " souls/hour, " +
    FormatFactor(ratio / curOutFactor) + " increase).");
}
function onFinishCompute(e) {
  if (e.data.ancient) {
    return onAddAncient(e);
  }
  var levels = e.data.levels;
  var outFactor = e.data.outFactor;
  var initFactor = e.data.initFactor;
  var souls = e.data.souls;

  var soulsSpent = 0;
  for (var k in Ancients) {
    var level = parseInt(Ancients[k].level.val());
    for (var lvl = 2; lvl <= level; lvl++) {
      soulsSpent += AncientPrice(k, lvl);
    }
  }

  if (!e.data.working) {
    loadSpinner.stop();
  }

  $("#soulsout").val(souls);
  for (var k in Ancients) {
    if (Ancients.hasOwnProperty(k)) {
      var oldLevel = parseInt(Ancients[k].level.val());
      if (levels[k] > oldLevel) {
        Ancients[k].targetBox.addClass("hilite");
        Ancients[k].target.val(levels[k] + " (+" + (levels[k] - oldLevel) + ")");
      } else {
        Ancients[k].targetBox.removeClass("hilite");
        Ancients[k].target.val(levels[k] ? levels[k] : "");
      }
    }
  }
  var outLog = "";
  outLog += "Souls/hour: " + Math.round(outFactor.ratio * 3600) + "<br/>\n";
  outLog += "Optimal level: " + outFactor.level + ", souls: " + Math.round(outFactor.souls) + ", time: " + FormatTime(outFactor.time) + "<br/>\n";
  outLog += "Improvement over current: " + FormatFactor(outFactor.ratio / initFactor.ratio) + "<br/>\n";
  if (AbaddonMultiplier) {
    outLog += "Current DR multiplier: " + AbaddonMultiplier.toFixed(3) + " (~" + Math.round(Math.log(AbaddonMultiplier) / Math.log(1.1)) + " uses)<br/>\n";
  }
  outLog += "Souls spent on ancient levels: " + soulsSpent + "<br/>\n";
  if (!e.data.working) {
    outLog += "<div id=\"addancients\"></div>\n";
  }
  $("#output").html(outLog);
  if (!e.data.working) {
    curOutFactor = outFactor.ratio;
    curAddAncients = [];
    var addList = $("#addancients");
    for (var k in Ancients) {
      if (!levels[k] && Ancients[k].price <= curSouls && Ancients[k].used.prop("checked")) {
        var curItem = {ancient: k};
        curItem.line = $("<div></div>").html(
          "<a href=\"javascript:void(0)\" class=\"buybtn\" aid=\"" + k + "\" title=\"" + Ancients[k].desc + "\">Purchase " +
          Ancients[k].name + "</a>: " + Ancients[k].price + " souls <span id=\"add" + k + "\">" +
          "<img src=\"http://www.rivsoft.net/content/ancientloader.gif\"/></span>");
        curAddAncients.push(curItem);
      }
    }
    curAddAncients.sort(function(a, b) {return Ancients[a.ancient].price - Ancients[b.ancient].price;});
    for (var i = 0; i < curAddAncients.length; i++) {
      addList.append(curAddAncients[i].line);
      var k = curAddAncients[i].ancient;
      var levels = $.extend({}, curLevels);
      levels[k] = 1;
      computeThread.postMessage({cmd: "Compute", levels: levels, souls: curSouls - Ancients[k].price,
        gilded: GetGildedHeroes(), activity: curActivity, damageFactor: AchievementMultiplier, ancient: k, used: curUsed});
    }
    curLevels = null;
    curSouls = null;
    curActivity = null;
    curUsed = null;
    $(".buybtn").click(function() {
      var aid = $(this).attr("aid");
      Ancients[aid].level.val(1);
      $("#soulsin").val(parseInt($("#soulsin").val()) - Ancients[aid].price);
      StartCompute();
    });
  }
};

function StartCompute() {
  var levels = {};
  var used = {};
  var owned = OwnedNotInList;
  for (var k in Ancients) {
    if (Ancients.hasOwnProperty(k)) {
      levels[k] = parseInt(Ancients[k].level.val());
      if (levels[k]) {
        owned++;
      }
      if (Ancients[k].used.prop("checked")) {
        used[k] = true;
      }
    }
  }
  var souls = parseInt($("#soulsin").val());

  if (computeThread) {
    computeThread.terminate();
  }
  curAddAncients = null;
  computeThread = new Worker("ancientsworker10.js?ver=1");
  computeThread.onmessage = onFinishCompute;

  var nextPrice = ToPurchase[owned];
  for (var k in Ancients) {
    if (!levels[k]) {
      Ancients[k].price = nextPrice;
      if (Ancients[k].rolls) {
        Ancients[k].price += Math.ceil(nextPrice / 3) * Ancients[k].rolls;
      }
    }
  }

  var activity = null;
  if (!$("#idlemode").prop("checked")) {
    activity = {};
    var cdTypes = ["full", "half", "short"];
    for (var i = 0; i < cdTypes.length; i++) {
      activity[cdTypes[i]] = {count: parseFloat($("#cd" + cdTypes[i] + "num").val()),
                              cps:   parseFloat($("#cd" + cdTypes[i] + "cps").val())};
    }
    activity.none = parseFloat($("#cdnonecps").val());
  }

  loadSpinner.spin($("#ancienttbl")[0]);

  $("#output").empty();

  curLevels = levels;
  curSouls = souls;
  curActivity = activity;
  curUsed = used;
  computeThread.postMessage({cmd: "Compute", levels: levels, souls: souls, gilded: GetGildedHeroes(), activity: activity,
    damageFactor: AchievementMultiplier, used: used});

/*  if (AbaddonMultiplier) {
    outLog += "Without current Dark Ritual stacks: " + FormatFactor(outFactor / initFactor / AbaddonMultiplier) +
      " (current DR multiplier is " + AbaddonMultiplier.toFixed(3) + ", ~" + Math.round(Math.log(AbaddonMultiplier) / Math.log(1.1)) + " uses)<br/>\n";
  }
  var effAncients = [];
  if ($("#suggestbuy").prop("checked")) {
    for (var k in Ancients) {
      if (!savedLevels[k] && Ancients[k].price <= savedSouls) {
        levels = $.extend({}, savedLevels);
        souls = savedSouls - Ancients[k].price;
        levels[k] = 1;
        var tmpFactor = Solve();
        effAncients.push({ancient: k, factor: tmpFactor});
      }
    }
  }
  effAncients.sort(function(a, b) {return b.factor - a.factor;});
  for (var i = 0; i < effAncients.length; i++) {
    var ancient = Ancients[effAncients[i].ancient];
    outLog += "<a href=\"javascript:void(0)\" class=\"buybtn\" aid=\"" + effAncients[i].ancient + "\" title=\"" + ancient.desc + "\">Purchase " + ancient.name + "</a>: " +
              ancient.price + " souls, " + effAncients[i].factor.toExponential(3).replace("+", "") + " efficiency (" + FormatFactor(effAncients[i].factor / outFactor) +
              " improvement).<br/>\n";
  }*/
}

</script>

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','http://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-43123589-2', 'rivsoft.net');
  ga('send', 'pageview');

</script>

</body>
</html>